!function(e,t){if("function"==typeof define&&define.amd)define(["tappy-tcmp","ndef","tappy-systemfamily","tappy-basicnfcfamily"],t);else if("object"==typeof exports){var r=null;try{r=require("@taptrack/tappy")}catch(s){r=require("tappy-tcmp")}var o=null;try{o=require("@taptrack/ndef")}catch(s){o=require("ndef")}var a=null;try{a=require("@taptrack/tappy-systemfamily")}catch(s){a=require("tappy-systemfamily")}var n=null;try{n=require("@taptrack/tappy-basicnfcfamily")}catch(s){n=require("tappy-basicnfcfamily")}module.exports=t(r,o,a,n)}else e.TappyWrapper=t(e.Tappy,e.Ndef,e.TappySystemFamily,e.TappyBasicNfcFamily)}(this,function(e,t,r,s){var o=function(e){for(var t="",r=0;r<e.length;r++){var s=e[r].toString(16).toUpperCase();t=e[r]<=15?t.concat("0"+s):t.concat(s)}return t},a=function(){this.subscribers={}};a.prototype.publish=function(e){var t=this;if("undefined"==typeof e)throw new Error("Must specify a message to publish");if(arguments.length<=1)throw new Error("Must specify one message and one or more topics");for(var r=1;r<arguments.length;r++){if("string"!=typeof arguments[r])throw new Error("Invalid argument specified, must be a string topic");"function"==typeof t.subscribers[arguments[r]]&&t.subscribers[arguments[r]](e)}},a.prototype.setSubscriber=function(e,t){var r=this;if("function"!=typeof t)throw new Error("Subscriber must be a function");if("string"!=typeof e)throw new Error("Must subscribe to a string subject");r.subscribers[e]=t};var n=function(e){this.resolvers=e};n.prototype.checkFamily=function(e){for(var t=this,r=!1,s=0;s<t.resolvers.length;s++)r=r||t.resolvers[s].checkFamily(e);return r},n.prototype.resolveCommand=function(e){for(var t=this,r=0;r<t.resolvers.length;r++){var s=t.resolvers[r];if(s.checkFamily(e))return s.resolveCommand(e)}throw new Error("Unsupported command type")},n.prototype.resolveResponse=function(e){for(var t=this,r=0;r<t.resolvers.length;r++){var s=t.resolvers[r];if(s.checkFamily(e))return s.resolveResponse(e)}throw new Error("Unsupported response type")};var p=function(p){var i=this;"object"==typeof p.tappy&&null!==p.tappy?i.tappy=p.tappy:i.tappy=new e(p),i.eb=new a;var c=new n([new s.Resolver,new r.Resolver]);i.tappy.setMessageListener(function(a){if(i.eb.publish({message:a},"received"),c.checkFamily(a)){var n=null;try{n=c.resolveResponse(a)}catch(p){i.eb.publish({message:a,error:p},"invalid_message")}if(null===n)return;var g=s.Responses,y=r.Responses;if(g.TagFound.isTypeOf(n))i.eb.publish({message:a,resolved:n,tagTypeCode:n.getTagType(),tagType:e.resolveTagType(n.getTagType()),tagCode:n.getTagCode(),tagCodeStr:o(n.getTagCode())},"tag_found");else if(g.TagWritten.isTypeOf(n))i.eb.publish({message:a,resolved:n,tagTypeCode:n.getTagType(),tagType:e.resolveTagType(n.getTagType()),tagCode:n.getTagCode(),tagCodeStr:o(n.getTagCode())},"tag_written");else if(g.NdefFound.isTypeOf(n)){var f=a.getMessage(),l=null;try{l=t.Message.fromBytes(f)}catch(p){return void i.eb.publish({message:a,resolved:n,tagTypeCode:n.getTagType(),tagType:e.resolveTagType(n.getTagType()),tagCode:n.getTagCode(),tagCodeStr:o(n.getTagCode()),rawNdef:f,error:p},"invalid_ndef")}i.eb.publish({message:a,resolved:n,tagTypeCode:n.getTagType(),tagType:e.resolveTagType(n.getTagType()),tagCode:n.getTagCode(),tagCodeStr:o(n.getTagCode()),rawNdef:f,ndef:l},"ndef_found")}else g.TagLocked.isTypeOf(n)?i.eb.publish({message:a,resolved:n,tagTypeCode:n.getTagType(),tagType:e.resolveTagType(n.getTagType()),tagCode:n.getTagCode(),tagCodeStr:o(n.getTagCode())},"tag_locked"):g.ScanTimeout.isTypeOf(n)?i.eb.publish({message:a,resolved:n},"timeout_reached"):g.ApplicationError.isTypeOf(n)?i.eb.publish({message:a,resolved:n,description:n.getErrorMessage()},"error_message"):y.LcsMismatch.isTypeOf(n)?i.eb.publish({message:a,resolved:n,description:"LCS Mismatch"},"error_message"):y.LengthMismatch.isTypeOf(n)?i.eb.publish({message:a,resolved:n,description:"Message length mismatch"},"error_message"):y.ImproperMessageFormat.isTypeOf(n)?i.eb.publish({message:a,resolved:n,description:"Improper message format"},"error_message"):y.CrcMismatch.isTypeOf(n)?i.eb.publish({message:a,resolved:n,description:"CRC mismatch"},"error_message"):y.SystemError.isTypeOf(n)&&i.eb.publish({message:a,resolved:n,description:n.getErrorMessage()},"error_message")}}),i.tappy.setErrorListener(function(t,r){var s="Unknown error";switch(t){case e.ErrorType.NOT_CONNECTED:s="Tappy not connected";break;case e.ErrorType.CONNECTION_ERROR:s="Connection error";break;case e.ErrorType.INVALID_HDLC:s="Received invalid frame";break;case e.ErrorType.INVALID_TCMP:s="Received invalid packet"}i.eb.publish({errorType:t,data:r,description:s},"driver_error")})};return p.prototype.isConnected=function(){var e=this;return e.tappy.isConnected()},p.prototype.connect=function(e){var t=this;return t.tappy.connect(function(){"function"==typeof e&&e.apply(this,arguments),t.eb.publish({args:arguments},"connect")})},p.prototype.disconnect=function(e){var t=this;return t.tappy.disconnect(function(){"function"==typeof e&&e.apply(this,arguments),t.eb.publish({args:arguments},"disconnect")})},p.prototype.sendMessage=function(e){var t=this;t.tappy.sendMessage(e),t.eb.publish({message:e},"sent")},p.prototype.detectTag=function(e,t){var r=this;e="boolean"==typeof e&&e,t="number"==typeof t?t:0;var o=null;o=e?new s.Commands.StreamTags(t,s.PollingModes.GENERAL):new s.Commands.ScanTag(t,s.PollingModes.GENERAL),r.sendMessage(o)},p.prototype.detectNdef=function(e,t){var r=this;e="boolean"==typeof e&&e,t="number"==typeof t?t:0;var o=null;o=e?new s.Commands.StreamNdef(t,s.PollingModes.GENERAL):new s.Commands.ScanNdef(t,s.PollingModes.GENERAL),r.sendMessage(o)},p.prototype.writeUrl=function(){var e=this;e.writeUri.apply(e,arguments)},p.prototype.writeUri=function(e,r,o){var a=this;e="string"==typeof e?e:"",r="boolean"==typeof r&&r,o="number"==typeof o?o:0;var n=t.Utils.resolveUriToPrefix(e),p=new s.Commands.WriteNdefUri(o,r,n.content,n.prefixCode);a.sendMessage(p)},p.prototype.writeText=function(e,t,r){var o=this;e="string"==typeof e?e:"",t="boolean"==typeof t&&t,r="number"==typeof r?r:0,msg=new s.Commands.WriteNdefText(r,t,e),o.sendMessage(msg)},p.prototype.writeNdef=function(e,t,r){var o=this;t="boolean"==typeof t&&t,r="number"==typeof r?r:0;var a=new s.Commands.WriteNdefCustom(r,t,e);o.sendMessage(a)},p.prototype.lockTag=function(e,t){var r=this;e=e||null,t="number"==typeof t?t:0;var o=new s.Commands.LockTag(t,e);r.sendMessage(o)},p.prototype.stop=function(){var e=this,t=new s.Commands.Stop;e.sendMessage(t)},p.prototype.on=function(e,t){var r=this;r.eb.setSubscriber(e,t)},p});
!function(e,t){if("function"==typeof define&&define.amd)define(["tappy-tcmp","ndef","tappy-systemfamily","tappy-basicnfcfamily"],t);else if("object"==typeof exports){var r=null;try{r=require("@taptrack/tappy")}catch(s){r=require("tappy-tcmp")}var o=null;try{o=require("@taptrack/ndef")}catch(s){o=require("ndef")}var a=null;try{a=require("@taptrack/tappy-systemfamily")}catch(s){a=require("tappy-systemfamily")}var n=null;try{n=require("@taptrack/tappy-basicnfcfamily")}catch(s){n=require("tappy-basicnfcfamily")}module.exports=t(r,o,a,n)}else e.TappyWrapper=t(e.Tappy,e.Ndef,e.TappySystemFamily,e.TappyBasicNfcFamily)}(this,function(e,t,r,s){var o=function(e){for(var t="",r=0;r<e.length;r++){var s=e[r].toString(16).toUpperCase();t=e[r]<=15?t.concat("0"+s):t.concat(s)}return t},a=function(){this.subscribers={}};a.prototype.publish=function(e){var t=this;if("undefined"==typeof e)throw new Error("Must specify a message to publish");if(arguments.length<=1)throw new Error("Must specify one message and one or more topics");for(var r=1;r<arguments.length;r++){if("string"!=typeof arguments[r])throw new Error("Invalid argument specified, must be a string topic");"function"==typeof t.subscribers[arguments[r]]&&t.subscribers[arguments[r]](e)}},a.prototype.setSubscriber=function(e,t){var r=this;if("function"!=typeof t)throw new Error("Subscriber must be a function");if("string"!=typeof e)throw new Error("Must subscribe to a string subject");r.subscribers[e]=t};var n=function(e){this.resolvers=e};n.prototype.checkFamily=function(e){for(var t=this,r=!1,s=0;s<t.resolvers.length;s++)r=r||t.resolvers[s].checkFamily(e);return r},n.prototype.resolveCommand=function(e){for(var t=this,r=0;r<t.resolvers.length;r++){var s=t.resolvers[r];if(s.checkFamily(e))return s.resolveCommand(e)}throw new Error("Unsupported command type")},n.prototype.resolveResponse=function(e){for(var t=this,r=0;r<t.resolvers.length;r++){var s=t.resolvers[r];if(s.checkFamily(e))return s.resolveResponse(e)}throw new Error("Unsupported response type")};var i=function(i){var p=this;"object"==typeof i.tappy&&null!==i.tappy?p.tappy=i.tappy:p.tappy=new e(i),p.eb=new a;var g=new n([new s.Resolver,new r.Resolver]);p.tappy.setMessageListener(function(a){if(p.eb.publish({message:a},"received"),g.checkFamily(a)){var n=null;try{n=g.resolveResponse(a)}catch(i){p.eb.publish({message:a,error:i},"invalid_message")}if(null===n)return;var c=s.Responses,y=r.Responses;if(c.TagFound.isTypeOf(n))p.eb.publish({message:a,resolved:n,tagTypeCode:a.getTagType(),tagType:e.resolveTagType(a.getTagType()),tagCode:a.getTagCode(),tagCodeStr:o(a.getTagCode())},"tag_found");else if(c.TagWritten.isTypeOf(n))p.eb.publish({message:a,resolved:n,tagTypeCode:a.getTagType(),tagType:e.resolveTagType(a.getTagType()),tagCode:a.getTagCode(),tagCodeStr:o(a.getTagCode())},"tag_written");else if(c.NdefFound.isTypeOf(n)){var l=a.getMessage(),d=null;try{d=t.Message.fromBytes(l)}catch(i){return void p.eb.publish({message:a,resolved:n,tagTypeCode:a.getTagType(),tagType:e.resolveTagType(a.getTagType()),tagCode:a.getTagCode(),tagCodeStr:o(a.getTagCode()),rawNdef:l,error:i},"invalid_ndef")}p.eb.publish({message:a,resolved:n,tagTypeCode:a.getTagType(),tagType:e.resolveTagType(a.getTagType()),tagCode:a.getTagCode(),tagCodeStr:o(a.getTagCode()),rawNdef:l,ndef:d},"ndef_found")}else c.TagLocked.isTypeOf(n)?p.eb.publish({message:a,resolved:n,tagTypeCode:a.getTagType(),tagType:e.resolveTagType(a.getTagType()),tagCode:a.getTagCode(),tagCodeStr:o(a.getTagCode())},"tag_locked"):c.ApplicationError.isTypeOf(n)?p.eb.publish({message:a,resolved:n,description:n.getErrorMessage()},"error_message"):y.LcsMismatch.isTypeOf(n)?p.eb.publish({message:a,resolved:n,description:"LCS Mismatch"},"error_message"):y.LengthMismatch.isTypeOf(n)?p.eb.publish({message:a,resolved:n,description:"Message length mismatch"},"error_message"):y.ImproperMessageFormat.isTypeOf(n)?p.eb.publish({message:a,resolved:n,description:"Improper message format"},"error_message"):y.CrcMismatch.isTypeOf(n)?p.eb.publish({message:a,resolved:n,description:"CRC mismatch"},"error_message"):y.SystemError.isTypeOf(n)&&p.eb.publish({message:a,resolved:n,description:n.getErrorMessage()},"error_message")}}),p.tappy.setErrorListener(function(t,r){var s="Unknown error";switch(t){case e.ErrorType.NOT_CONNECTED:s="Tappy not connected";break;case e.ErrorType.CONNECTION_ERROR:s="Connection error";break;case e.ErrorType.INVALID_HDLC:s="Received invalid frame";break;case e.ErrorType.INVALID_TCMP:s="Received invalid packet"}p.eb.publish({errorType:t,data:r,description:s},"driver_error")})};return i.prototype.isConnected=function(){var e=this;return e.tappy.isConnected()},i.prototype.connect=function(e){var t=this;return t.tappy.connect(function(){"function"==typeof e&&e.apply(this,arguments),t.eb.publish({args:arguments},"connect")})},i.prototype.disconnect=function(e){var t=this;return t.tappy.disconnect(function(){"function"==typeof e&&e.apply(this,arguments),t.eb.publish({args:arguments},"disconnect")})},i.prototype.sendMessage=function(e){var t=this;t.tappy.sendMessage(e),t.eb.publish({message:e},"sent")},i.prototype.detectTag=function(e){var t=this;e="boolean"==typeof e&&e;var r=null;r=e?new s.Commands.StreamTags(0,s.PollingModes.GENERAL):new s.Commands.ScanTag(0,s.PollingModes.GENERAL),t.sendMessage(r)},i.prototype.detectNdef=function(e){var t=this;e="boolean"==typeof e&&e;var r=null;r=e?new s.Commands.StreamNdef(0,s.PollingModes.GENERAL):new s.Commands.ScanNdef(0,s.PollingModes.GENERAL),t.sendMessage(r)},i.prototype.writeUrl=function(){var e=this;e.writeUri.apply(e,arguments)},i.prototype.writeUri=function(e,r){var o=this;e="string"==typeof e?e:"",r="boolean"==typeof r&&r;var a=t.Utils.resolveUriToPrefix(e),n=new s.Commands.WriteNdefUri(0,r,a.content,a.prefixCode);o.sendMessage(n)},i.prototype.writeText=function(e,t){var r=this;e="string"==typeof e?e:"",t="boolean"==typeof t&&t,msg=new s.Commands.WriteNdefText(0,t,e),r.sendMessage(msg)},i.prototype.writeNdef=function(e,t){var r=this;t="boolean"==typeof t&&t;var o=new s.Commands.WriteNdefCustom(0,t,e);r.sendMessage(o)},i.prototype.lockTag=function(e){var t=this;e=e||null;var r=new s.Commands.LockTag(0,e);t.sendMessage(r)},i.prototype.stop=function(){var e=this,t=new s.Commands.Stop;e.sendMessage(t)},i.prototype.on=function(e,t){var r=this;r.eb.setSubscriber(e,t)},i});
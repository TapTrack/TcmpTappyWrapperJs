!function(e,r){if("function"==typeof define&&define.amd)define(["tappy-tcmp","ndef","tappy-systemfamily","tappy-basicnfcfamily"],r);else if("object"==typeof exports){var t=null;try{t=require("@taptrack/tappy")}catch(s){t=require("tappy-tcmp")}var o=null;try{o=require("@taptrack/ndef")}catch(s){o=require("ndef")}var a=null;try{a=require("@taptrack/tappy-systemfamily")}catch(s){a=require("tappy-systemfamily")}var n=null;try{n=require("@taptrack/tappy-basicnfcfamily")}catch(s){n=require("tappy-basicnfcfamily")}module.exports=r(t,o,a,n)}else e.TappyWrapper=r(e.Tappy,e.Ndef,e.TappySystemFamily,e.TappyBasicNfcFamily)}(this,function(e,r,t,s){var o=function(e){for(var r="",t=0;t<e.length;t++){var s=e[t].toString(16).toUpperCase();r=e[t]<=15?r.concat("0"+s):r.concat(s)}return r},a=function(){this.subscribers={}};a.prototype.publish=function(e){var r=this;if("undefined"==typeof e)throw new Error("Must specify a message to publish");if(arguments.length<=1)throw new Error("Must specify one message and one or more topics");for(var t=1;t<arguments.length;t++){if("string"!=typeof arguments[t])throw new Error("Invalid argument specified, must be a string topic");"function"==typeof r.subscribers[arguments[t]]&&r.subscribers[arguments[t]](e)}},a.prototype.setSubscriber=function(e,r){var t=this;if("function"!=typeof r)throw new Error("Subscriber must be a function");if("string"!=typeof e)throw new Error("Must subscribe to a string subject");t.subscribers[e]=r};var n=function(e){this.resolvers=e};n.prototype.checkFamily=function(e){for(var r=this,t=!1,s=0;s<r.resolvers.length;s++)t=t||r.resolvers[s].checkFamily(e);return t},n.prototype.resolveCommand=function(e){for(var r=this,t=0;t<r.resolvers.length;t++){var s=r.resolvers[t];if(s.checkFamily(e))return s.resolveCommand(e)}throw new Error("Unsupported command type")},n.prototype.resolveResponse=function(e){for(var r=this,t=0;t<r.resolvers.length;t++){var s=r.resolvers[t];if(s.checkFamily(e))return s.resolveResponse(e)}throw new Error("Unsupported response type")};var i=function(i){var p=this;"object"==typeof i.tappy&&null!==i.tappy?p.tappy=i.tappy:p.tappy=new e(i),p.eb=new a;var c=new n([new s.Resolver,new t.Resolver]);p.userMessageListener=function(){},p.tappy.setMessageListener(function(a){if(p.eb.publish({message:a},"received"),p.userMessageListener(a),c.checkFamily(a)){var n=null;try{n=c.resolveResponse(a)}catch(i){p.eb.publish({message:a,error:i},"invalid_message")}if(null===n)return;var g=s.Responses,y=t.Responses;if(g.TagFound.isTypeOf(n))p.eb.publish({message:a,resolved:n,tagTypeCode:n.getTagType(),tagType:e.resolveTagType(n.getTagType()),tagCode:n.getTagCode(),tagCodeStr:o(n.getTagCode())},"tag_found");else if(g.TagWritten.isTypeOf(n))p.eb.publish({message:a,resolved:n,tagTypeCode:n.getTagType(),tagType:e.resolveTagType(n.getTagType()),tagCode:n.getTagCode(),tagCodeStr:o(n.getTagCode())},"tag_written");else if(g.NdefFound.isTypeOf(n)){var f=a.getMessage(),l=null;try{l=r.Message.fromBytes(f)}catch(i){return void p.eb.publish({message:a,resolved:n,tagTypeCode:n.getTagType(),tagType:e.resolveTagType(n.getTagType()),tagCode:n.getTagCode(),tagCodeStr:o(n.getTagCode()),rawNdef:f,error:i},"invalid_ndef")}p.eb.publish({message:a,resolved:n,tagTypeCode:n.getTagType(),tagType:e.resolveTagType(n.getTagType()),tagCode:n.getTagCode(),tagCodeStr:o(n.getTagCode()),rawNdef:f,ndef:l},"ndef_found")}else g.TagLocked.isTypeOf(n)?p.eb.publish({message:a,resolved:n,tagTypeCode:n.getTagType(),tagType:e.resolveTagType(n.getTagType()),tagCode:n.getTagCode(),tagCodeStr:o(n.getTagCode())},"tag_locked"):g.ScanTimeout.isTypeOf(n)?p.eb.publish({message:a,resolved:n},"timeout_reached"):g.ApplicationError.isTypeOf(n)?p.eb.publish({message:a,resolved:n,description:n.getErrorMessage()},"error_message"):y.LcsMismatch.isTypeOf(n)?p.eb.publish({message:a,resolved:n,description:"LCS Mismatch"},"error_message"):y.LengthMismatch.isTypeOf(n)?p.eb.publish({message:a,resolved:n,description:"Message length mismatch"},"error_message"):y.ImproperMessageFormat.isTypeOf(n)?p.eb.publish({message:a,resolved:n,description:"Improper message format"},"error_message"):y.CrcMismatch.isTypeOf(n)?p.eb.publish({message:a,resolved:n,description:"CRC mismatch"},"error_message"):y.SystemError.isTypeOf(n)&&p.eb.publish({message:a,resolved:n,description:n.getErrorMessage()},"error_message")}}),p.userErrorListener=function(){},p.tappy.setErrorListener(function(r,t){var s="Unknown error";switch(r){case e.ErrorType.NOT_CONNECTED:s="Tappy not connected";break;case e.ErrorType.CONNECTION_ERROR:s="Connection error";break;case e.ErrorType.INVALID_HDLC:s="Received invalid frame";break;case e.ErrorType.INVALID_TCMP:s="Received invalid packet"}p.eb.publish({errorType:r,data:t,description:s},"driver_error"),p.userErrorListener(r,t)})};return i.prototype.setErrorListener=function(e){var r=this;r.userErrorListener=e},i.prototype.setMessageListener=function(e){var r=this;r.userMessageListener=e},i.prototype.isConnected=function(){var e=this;return e.tappy.isConnected()},i.prototype.connect=function(e){var r=this;return r.tappy.connect(function(){"function"==typeof e&&e.apply(this,arguments),r.eb.publish({args:arguments},"connect")})},i.prototype.disconnect=function(e){var r=this;return r.tappy.disconnect(function(){"function"==typeof e&&e.apply(this,arguments),r.eb.publish({args:arguments},"disconnect")})},i.prototype.sendMessage=function(e){var r=this;r.tappy.sendMessage(e),r.eb.publish({message:e},"sent")},i.prototype.detectTag=function(e,r){var t=this;e="boolean"==typeof e&&e,r="number"==typeof r?r:0;var o=null;o=e?new s.Commands.StreamTags(r,s.PollingModes.GENERAL):new s.Commands.ScanTag(r,s.PollingModes.GENERAL),t.sendMessage(o)},i.prototype.detectNdef=function(e,r){var t=this;e="boolean"==typeof e&&e,r="number"==typeof r?r:0;var o=null;o=e?new s.Commands.StreamNdef(r,s.PollingModes.GENERAL):new s.Commands.ScanNdef(r,s.PollingModes.GENERAL),t.sendMessage(o)},i.prototype.writeUrl=function(){var e=this;e.writeUri.apply(e,arguments)},i.prototype.writeUri=function(e,t,o){var a=this;e="string"==typeof e?e:"",t="boolean"==typeof t&&t,o="number"==typeof o?o:0;var n=r.Utils.resolveUriToPrefix(e),i=new s.Commands.WriteNdefUri(o,t,n.content,n.prefixCode);a.sendMessage(i)},i.prototype.writeText=function(e,r,t){var o=this;e="string"==typeof e?e:"",r="boolean"==typeof r&&r,t="number"==typeof t?t:0,msg=new s.Commands.WriteNdefText(t,r,e),o.sendMessage(msg)},i.prototype.writeNdef=function(e,r,t){var o=this;r="boolean"==typeof r&&r,t="number"==typeof t?t:0;var a=new s.Commands.WriteNdefCustom(t,r,e);o.sendMessage(a)},i.prototype.lockTag=function(e,r){var t=this;e=e||null,r="number"==typeof r?r:0;var o=new s.Commands.LockTag(r,e);t.sendMessage(o)},i.prototype.stop=function(){var e=this,r=new s.Commands.Stop;e.sendMessage(r)},i.prototype.on=function(e,r){var t=this;t.eb.setSubscriber(e,r)},i});